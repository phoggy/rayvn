#!/usr/bin/env bash
# shellcheck disable=SC2155

readonly VERSION='rayvn 0.1.0'

usage() {
    echo
    echo "Manage shared bash libraries."
    echo
    echo "Usage: ${scriptName} <options>"
    echo
    echo "Options:"
    echo
    echo "    --install           Install rayvn by itself."
    echo "    -a, --add PATH      Add project at PATH, which must contain a 'rayvn.meta' file at the root."
    echo "    -r, --remove PATH   Remove project at PATH, which must contain a 'rayvn.meta' file at the root."
    echo "    -l, --list          List installed libraries."
    echo "    -h, --help          Display usage and exit."
    echo "    --version           Display version and exit."
    echo
    echo "The 'rayvn.meta' may contain the following key=value declarations:"
    echo
    echo "  'namespace = <name>'  Declares the namespace name for shared libraries in the \${PATH}/lib directory."
    echo
    echo "  'binaries = <names>'  Declares one or more binaries int the \${PATH}/bin directory that should be included"
    echo "                        in the search path. Can be a comma separated list or '*' to add all."
    echo
    _bye "${@}"
}

main() {
    init "${@}"
    case "${action}" in
        add) installProject ;;
        remove) removeNamespace ;;
        list) listNamespaces ;;
        test) testRequireCore ;;
        reset) reset ;;
        install) install ;;
        *) usage ;;
    esac
}

init() {
    readonly scriptName=$(basename "${0}")
    readonly rayvnHome="${HOME}/.rayvn"
    readonly rayvnLibDir="${rayvnHome}/lib"
    readonly rayvnBinDir="${rayvnHome}/bin"
    readonly bootFile="${rayvnHome}/boot.sh"
    readonly metaDataFile="rayvn.meta"

    action=
    namespace=
    sourceDir=
    nameSpaceRef=

    while (( ${#} > 0 )); do
        case "${1}" in
            -a | --add) shift; loadProject "${1}"; action='add' ;;
            -r | --remove) shift; loadProject "${1}"; action='remove' ;;
            -l | --list) action='list' ;;
            --install) action='install' ;;
            --reset) action='reset' ;;
            --test) action='test' ;;
            -h | --help) usage ;;
            --version) version ${VERSION} ;;
            *) usage "Unknown option: ${1}" ;;
        esac
        shift
    done

    if [[ ${action} ]]; then
        if [[ ${action} != 'reset' ]]; then
           install
        fi
    else
        usage
    fi
}

loadProject() {
    declare -g projectDir meta namespace binaries
    projectDir="${1}"
    [[ -d "${projectDir}" ]] || _bye "project directory '${projectDir}' not found"
    metaFile="${projectDir}/${metaDataFile}"
    [[ -f ${metaFile} ]] || _bye "'${metaFile}' not found"
    meta="$(cat ${metaFile})"

    # Get supported declarations from the metadata

    namespace="$(getMetaValue namespace)"
    binaries="$(getMetaValue binaries)"

    # Do we have any declarations?

    if [[ ! ${namespace} && ! ${binaries} ]]; then
        _bye "No supported '<key> = <value>' declarations found in '${metaFile}'"
    fi
}

getMetaValue() {
    local key=${1}
    local definition="$(echo "${meta}" | grep ${key} | tr -d '[:space:]')"
    definition=${definition%#*} # strip any comments

    if [[ ${definition} ]]; then
        local value="${definition#*=}"
        echo "${value}"
    fi
}

installProject() {

    # Install namespace if defined

    if [[ ${namespace} ]]; then
        sourceDir="${projectDir}/lib"
        [[ -d ${sourceDir} ]] || _bye "directory '${sourceDir}' not found"
        nameSpaceRef="${rayvnLibDir}/${namespace}"
        [[ -e ${nameSpaceRef} ]] && _bye "${namespace} already present: ${nameSpaceRef} "

        # Create namespace link to actual directory

        ln -s "${sourceDir}" "${nameSpaceRef}"
        echo "added shared library root ${sourceDir} as '${namespace}' namespace"
    fi

    # Install binaries if defined

    if [[ ${binaries} ]]; then

        local sourceDir="${projectDir}/bin"
        [[ -d ${sourceDir} ]] || _bye "directory '${sourceDir}' not found"
        local executables=()

        # Yes. All of them?

        if [[ ${binaries} == '*' ]]; then

            # Yes, so build list

            for fileName in $(ls -1 "${sourceDir}" | tr '\n' ' '); do
                executables+=("${fileName}")
            done

        else
            # Nope, specific ones

            executables=("$(echo ${binaries} | tr ',' ' ')")
        fi

        # Install links for each

        for binary in "${executables[@]}"; do
            local binaryRef="${rayvnBinDir}/${binary}"
            local binarySrc="${sourceDir}/${binary}"
            ln -s "${binarySrc}" "${binaryRef}"
            echo "added executable ${binary}"
        done
    fi
}

listNamespaces() {
    cd "${rayvnLibDir}" || _bye "rayvn not installed!"
    ls -l
}

removeNamespace() {
    [[ -e ${nameSpaceRef} ]] || _bye "${namespace} not found"
    currentNameSpaceDir="$(realpath "${sourceDir}")"
    [[ ${sourceDir} == "${currentNameSpaceDir}" ]] || _bye "namespace '${namespace} points elsewhere: ${currentNameSpaceDir}"
    echo "removing '${sourceDir}' as '${namespace}'"
    unlink "${nameSpaceRef}"
}

testRequireCore() {
    [[ ${RAYVN_LIBRARY_core__base} ]] && _bye "core/base already loaded!"

    # this is how each script is supposed to bring it in.
    source "${HOME}/.rayvn/boot.sh" 2> /dev/null || { echo 'rayvn not installed' && exit 0; }
    require 'core/base'

    echo "'$(ansi bold require core/base)' worked if $(ansi bold_green this) line has $(ansi magenta colored) text"
    [[ ${RAYVN_LIBRARY_core__base} ]] || _bye "core/base not loaded!"
    [[ ${RAYVN_LIBRARY_core__base} == 'loaded' ]] || _bye "core/base variable set to unexpected value: ${RAYVN_LIBRARY_core__base}!"
}

reset() {
   rm -rf "${rayvnHome}" || _bye
   install
}

install() {
    if [[ ! -f ${bootFile} ]]; then
        mkdir -p "${rayvnLibDir}" 2> /dev/null
        mkdir -p "${rayvnBinDir}" 2> /dev/null

        # generate boot script
        (
            echo "#!/usr/bin/env bash"
            echo
            echo "declare -grx rayvnLibDir=\"${HOME}/.rayvn/lib\""
            echo "declare -grx rayvnBinDir=\"${HOME}/.rayvn/bin\""
            echo
            declare -f require
            echo
            declare -f bye
            echo
            declare -rf require

        ) > "${bootFile}"

        # Install rayvn itself

        loadProject "$(realpath "${BASH_SOURCE%/*/*}")"
        installProject

        # Modify .bashrc to append ${rayvnBinDir} to PATH

        if ! grep '.rayvn/bin' ${HOME}/.bashrc > /dev/null; then
            (
                echo
                echo "PATH=\${PATH}:${rayvnBinDir}   # Ensure rayvn binaries can be found"
            ) >>"${HOME}/.bashrc"
            echo "updated .bashrc to include binaries in PATH"
        fi
    fi
}

require() {
    local qualifiedName="${1}"
    local nameSpace="${qualifiedName%/*}"
    local libraryName="${qualifiedName#*/}"
    local libraryVarName="RAYVN_LIBRARY_${nameSpace}__${libraryName}"
    if [[ ! ${!libraryVarName} ]]; then
        local nameSpaceDir="${rayvnLibDir}/${nameSpace}"
        local libraryFile="${nameSpaceDir}/${libraryName}.sh"
        [[ -d ${nameSpaceDir} ]] || _bye "rayvn namespace '${nameSpace}' not found"
        [[ -f ${libraryFile} ]] || _bye "rayvn library '${libraryName}' not found"
        #echo "${BASHPID}: BEGIN loading ${libraryFile}" >> /tmp/debug.log
        source "${libraryFile}"
        local initFunction="init_${nameSpace}_${libraryName}"
        if [[ $(type -t ${initFunction}) == function  ]]; then
            #echo "    ${BASHPID}: initializing ${libraryFile}" >> /tmp/debug.log
            ${initFunction}
        fi
        #echo "${BASHPID}: END loading ${libraryFile}" >> /tmp/debug.log
        declare -grx ${libraryVarName}='loaded' # do not reload

        # Ensure ${nameSpace}_HOME is set libraries can reference their own dirs

        local homeVar="${nameSpace^^}_HOME"
        if [[ ! ${homeVar} ]]; then
            local homeDir="$(realpath ${nameSpaceDir}/..)"
            declare -grx ${homeVar}="${homeDir}"
            declare -p "${homeVar}" # TODO remove!
        fi
    fi
}

_bye() {
    if [[ ${1} ]]; then
        echo "${@}"
        exit 1
    else
        exit 0
    fi
}

main "${@}"





